<!doctype html>
<html lang="en" class="h-100">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link   rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" 
            integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
            crossorigin=""/>

    <title>PAThs road netwok proof of concept</title>
  </head>
  <body class="h-100">
    <div class="container-fluid h-100">
      <div class="row h-100">
        <div class="col-sm-4 p-5">

          <h3 class="mb-3">Calculate directions between PAThs places</h3>

          <div class="bg-warning p-3 my-5">
            <h5>CAVEAT</h5>
            <p>This demo is <u>only a proof of concept</u> and the underlying road graph 
              is <u>not yet complete or fully reliable</u>. Some connections might be missing
              and others need to be refined.</p>
          </div>

          <div class="form-group">
            <label for="from">From</label>
            <select class="form-control" id="from">
            </select>
          </div>
          
          <div class="form-group">
            <label for="to">To</label>
            <select class="form-control" id="to">
            </select>
          </div>

          <div class="form-group">
            <button class="btn btn-success btn-block" id="calculate">Calculate</button>
          </div>

          <div class="mt-2 border-top pt-2">
            <p>If you want to collaborate or if you need more information 
              <a class="" href="mailto:julian.bogdani@uniroma1.it">drop us a line</a>.
              <br>This is a <a href="http://paths.uniroma1.it" target="_blank">PAThs project</a>.
            </p>
          </div>

        </div>

        <div class="col-sm-8 h-100">
          <div id="map" class="h-100"></div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script src="./bundle.js"></script>

    <script>
      var map = L.map('map').setView([30.0594885,31.2584644], 8);

      // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      // }).addTo(map);
      L.tileLayer('https://dh.gu.se/tiles/imperium/{z}/{x}/{y}.png').addTo(map);

      const from = document.getElementById('from');
      const to = document.getElementById('to');
      fetch('https://bdus.cloud/db/api/paths?verb=search&&geojson=1&shortsql=@places~[id,name,geodata.geometry~-500:0~%3Ename:asc')
        .then(resp => resp.json())
        .then(d => {

          L.geoJSON(d, {
            onEachFeature: (feature, layer) => {
              if (feature.properties && feature.properties.name) {
                layer.bindPopup(`<div class="text-center">
                  <strong>${feature.properties.name}</strong>
                  <hr>
                  <a href="https://atlas.paths-erc.eu/places/${feature.properties.id}" target="_blank"><big>paths.place.${feature.properties.id}</big></a>
                  <hr>
                  <a href="#" onclick="directions('from', '${feature.geometry.coordinates.join(' ')}')">Directions from here</a>
                  |
                  <a href="#" onclick="directions('to', '${feature.geometry.coordinates.join(' ')}')">Directions to here</a>
                  </div>
                  `);
              }
            },
            pointToLayer: (t, i, col) => {
              return new L.CircleMarker(i, {
                radius: 5,
                weight: 1,
                color: '#0000ff'
              })
            }
          }).addTo(map)

          d.features.map( e => {
            from.options[from.options.length] = new Option(e.properties.name, e.geometry.coordinates.join(' '), false, (e.properties.name === data.fromPlace))
            to.options[to.options.length] = new Option(e.properties.name, e.geometry.coordinates.join(' '), false, (e.properties.name === data.toPlace))
          });
        });
      
      let geoJsonLayer;

      const coordsToHash = function (fromPlace, toPlace, fromCoord, toCoord){
        window.location.hash = `${encodeURIComponent(fromPlace)}/${encodeURIComponent(toPlace)}/${fromCoord.join(',')}/${toCoord.join(',')}`;
      }

      const directions = (fromTo, coords) => {
        document.querySelector(`#${fromTo} [value="${coords}"]`).selected = true;
        return false;
      }

      const hashToCoords = () => {
        let hashUrl = window.location.hash;

        if (hashUrl === ''){
          return false;
        }
        hashUrl = hashUrl.substring(1);

        const parts = hashUrl.split('/');

        return {
          fromPlace : decodeURIComponent(parts[0]),
          toPlace   : decodeURIComponent(parts[1]),
          fromCoord : parts[2].split(','),
          toCoord   : parts[3].split(','),
        };
      }


      const calcAndShow = (fromCoord, toCoord) => {
        const path = calcPath(fromCoord, toCoord);
        if (!path){
          alert(`Cannot calculate path from ${from.options[from.selectedIndex].text} to ${to.options[to.selectedIndex].text}`);
          return;
        }

        if (typeof geoJsonLayer !== 'undefined'){
          map.removeLayer(geoJsonLayer);
        }

        geoJsonLayer = L.geoJSON(path).addTo(map);
        map.fitBounds(geoJsonLayer.getBounds());
      };



      document.getElementById('calculate').addEventListener('click', () => {
        if (from.value === to.value){
          alert('From e To can not be the same place!');
          return;
        }
        const fromCoord = from.value.split(' ');
        const toCoord = to.value.split(' ');

        coordsToHash(from.options[from.selectedIndex].text, to.options[to.selectedIndex].text, fromCoord, toCoord);

        calcAndShow(fromCoord, toCoord);

      });

      const data = hashToCoords();
      if ( data && data.fromCoord && data.toCoord ){
        calcAndShow(data.fromCoord, data.toCoord);
      }
      
    </script>
  </body>
</html>
